<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Make a ten!</title>
    <style>
        :root {
            --bg: #f8fafc;
            --card-bg: #ffffff;
            --primary: #3b82f6;
            --success: #22c55e;
            --danger: #ef4444;
            --accent: #f59e0b;
            --text: #1e293b;
            --selected: #dbeafe;
        }

        body {
            font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
            background-color: var(--bg);
            color: var(--text);
            text-align: center;
            margin: 0;
            padding: 10px;
            overflow-x: hidden;
            touch-action: manipulation;
            user-select: none;
            -webkit-user-select: none;
        }

        .header { margin-bottom: 20px; }
        h1 { margin: 10px 0; font-size: 1.8rem; color: #334155; }

        .stats {
            display: flex;
            justify-content: center;
            gap: 20px;
            font-size: 1rem;
            font-weight: bold;
        }
        #high-score { color: var(--accent); }

        /* 数字カードエリア：位置固定のため幅を指定 */
        #numbers-container {
            display: flex;
            justify-content: center;
            gap: 12px;
            margin-bottom: 30px;
            min-height: 85px;
        }

        .num-card {
            width: 70px;
            height: 70px;
            background: var(--card-bg);
            border: 3px solid var(--primary);
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.8rem;
            font-weight: 900;
            cursor: pointer;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            transition: transform 0.1s, background-color 0.2s;
            touch-action: none;
        }
        
        .num-card.selected {
            background-color: var(--selected);
            transform: scale(1.1);
            border-style: dashed;
        }

        .num-card.dragging { opacity: 0.4; }

        /* スロットエリア */
        #lists-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
            gap: 10px;
            max-width: 600px;
            margin: 0 auto;
        }

        .slot {
            height: 140px;
            background: var(--card-bg);
            border: 3px solid #e2e8f0;
            border-radius: 16px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
        }
        .slot h3 { font-size: 0.7rem; color: #94a3b8; margin: 0; }
        .slot .total-val { font-size: 2.5rem; font-weight: 800; color: #475569; margin: 0; }

        @media (max-width: 480px) {
            #lists-container { grid-template-columns: repeat(3, 1fr); }
            .slot { height: 120px; }
            .slot .total-val { font-size: 2rem; }
            h1 { font-size: 1.5rem; }
        }

        .slot.drag-over { border-color: var(--primary); background: #eff6ff; }
        
        .slot.success-flash { animation: success-ani 0.5s ease-out; }
        @keyframes success-ani {
            0% { transform: scale(1); border-color: var(--success); }
            50% { transform: scale(1.05); border-color: var(--success); box-shadow: 0 0 20px rgba(34, 197, 94, 0.4); }
            100% { transform: scale(1); border-color: #e2e8f0; }
        }

        .slot.broken {
            background: #f1f5f9;
            border-color: var(--danger);
            opacity: 0.6;
            animation: shake 0.4s ease-in-out;
        }
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-5px); }
            75% { transform: translateX(5px); }
        }

        #combo-popup {
            position: fixed;
            top: 40%; left: 50%;
            transform: translate(-50%, -50%);
            font-size: 3rem;
            font-weight: 900;
            color: var(--accent);
            text-shadow: 2px 2px 0 #fff;
            pointer-events: none;
            opacity: 0;
            z-index: 1000;
        }
        .animate-combo { animation: combo-float 0.8s ease-out forwards; }
        @keyframes combo-float {
            0% { opacity: 0; transform: translate(-50%, 0) scale(0.5); }
            50% { opacity: 1; transform: translate(-50%, -50%) scale(1.1); }
            100% { opacity: 0; transform: translate(-50%, -80%) scale(1); }
        }
    </style>
</head>
<body>

    <div class="header">
        <h1>Make a ten!</h1>
        <div class="stats">
            <div>SCORE: <span id="score">0</span></div>
            <div>HIGH: <span id="high-score">0</span></div>
        </div>
    </div>

    <div id="numbers-container"></div>
    <div id="lists-container"></div>
    <div id="combo-popup">COMBO!</div>

    <script>
        const AudioSys = {
            ctx: new (window.AudioContext || window.webkitAudioContext)(),
            play(f, type, d, v = 0.05) {
                try {
                    if(this.ctx.state === 'suspended') this.ctx.resume();
                    const o = this.ctx.createOscillator();
                    const g = this.ctx.createGain();
                    o.type = type;
                    o.frequency.setValueAtTime(f, this.ctx.currentTime);
                    g.gain.setValueAtTime(v, this.ctx.currentTime);
                    g.gain.exponentialRampToValueAtTime(0.01, this.ctx.currentTime + d);
                    o.connect(g); g.connect(this.ctx.destination);
                    o.start(); o.stop(this.ctx.currentTime + d);
                } catch(e) {}
            },
            pick() { this.play(880, 'sine', 0.05); },
            success(c) {
                const base = 523.25 + (c * 40);
                this.play(base, 'sine', 0.2);
                setTimeout(() => this.play(base * 1.5, 'sine', 0.3), 100);
            },
            error() { this.play(150, 'sawtooth', 0.3); }
        };

        let score = 0;
        let highScore = localStorage.getItem('tenGameHighScore') || 0;
        let combo = 0;
        let lastSuccessTime = 0;
        let selectedValue = null;
        let selectedCardElement = null;
        const COMBO_LIMIT = 2500;

        document.getElementById('high-score').textContent = highScore;

        function init() {
            createSlots();
            generateNumbers();
        }

        function createSlots() {
            const container = document.getElementById("lists-container");
            container.innerHTML = "";
            for (let i = 0; i < 5; i++) {
                const div = document.createElement("div");
                div.className = "slot";
                div.innerHTML = `<h3>TOTAL</h3><p class="total-val">0</p>`;
                div.dataset.val = 0;
                
                div.ondragover = (e) => { e.preventDefault(); if(!div.classList.contains('broken')) div.classList.add('drag-over'); };
                div.ondragleave = () => div.classList.remove('drag-over');
                div.ondrop = (e) => {
                    const val = e.dataTransfer.getData("text");
                    executeMove(div, parseInt(val));
                };

                div.onclick = () => {
                    if (selectedValue !== null) {
                        executeMove(div, selectedValue);
                    }
                };
                
                container.appendChild(div);
            }
        }

        function generateNumbers() {
            const container = document.getElementById("numbers-container");
            container.innerHTML = ""; // ここで物理的にクリアされる
            selectedValue = null;
            selectedCardElement = null;

            for (let i = 0; i < 3; i++) {
                const val = Math.floor(Math.random() * 9) + 1;
                const card = document.createElement("div");
                card.className = "num-card";
                card.textContent = val;
                card.draggable = true;

                card.ondragstart = (e) => {
                    AudioSys.pick();
                    e.dataTransfer.setData("text", val);
                    card.classList.add('dragging');
                    selectCard(card, val);
                };
                card.ondragend = () => card.classList.remove('dragging');

                card.onclick = (e) => {
                    e.stopPropagation();
                    AudioSys.pick();
                    selectCard(card, val);
                };

                container.appendChild(card);
            }
        }

        function selectCard(card, val) {
            document.querySelectorAll('.num-card').forEach(c => c.classList.remove('selected'));
            card.classList.add('selected');
            selectedValue = val;
            selectedCardElement = card;
        }

        function executeMove(slot, val) {
            slot.classList.remove('drag-over');
            if (slot.classList.contains('broken') || isNaN(val)) return;

            // 使用したカードを「消去」せず「不可視化」して場所を保持
            if (selectedCardElement) {
                selectedCardElement.style.visibility = 'hidden';
                selectedCardElement.style.pointerEvents = 'none';
                selectedValue = null;
                selectedCardElement = null;
            } else {
                const cards = document.querySelectorAll('.num-card');
                for(let c of cards) {
                    // まだ表示されているカードの中から対象を探す
                    if(parseInt(c.textContent) === val && c.style.visibility !== 'hidden') { 
                        c.style.visibility = 'hidden';
                        c.style.pointerEvents = 'none';
                        break; 
                    }
                }
            }

            let total = parseInt(slot.dataset.val) + val;
            slot.dataset.val = total;
            slot.querySelector(".total-val").textContent = total;

            if (total === 10) {
                handleSuccess(slot);
            } else if (total > 10) {
                handleBurst(slot);
            }

            // 非表示のカードも含め、全てが invisible になったら次を生成
            const visibleCards = Array.from(document.querySelectorAll('.num-card'))
                                     .filter(c => c.style.visibility !== 'hidden');
            if (visibleCards.length === 0) generateNumbers();
        }

        function handleSuccess(slot) {
            const now = Date.now();
            combo = (now - lastSuccessTime < COMBO_LIMIT) ? combo + 1 : 1;
            lastSuccessTime = now;

            score += 10 * combo;
            updateScore();
            AudioSys.success(combo);
            if(combo > 1) showComboUI();

            slot.classList.add('success-flash');
            setTimeout(() => {
                slot.classList.remove('success-flash');
                slot.dataset.val = 0;
                slot.querySelector(".total-val").textContent = "0";
            }, 500);
        }

        function handleBurst(slot) {
            slot.classList.add('broken');
            combo = 0;
            AudioSys.error();
            checkGameOver();
        }

        function updateScore() {
            document.getElementById('score').textContent = score;
            if (score > highScore) {
                highScore = score;
                document.getElementById('high-score').textContent = highScore;
                localStorage.setItem('tenGameHighScore', highScore);
            }
        }

        function showComboUI() {
            const popup = document.getElementById('combo-popup');
            popup.textContent = `${combo} COMBO!`;
            popup.classList.remove('animate-combo');
            void popup.offsetWidth; 
            popup.classList.add('animate-combo');
        }

        function checkGameOver() {
            const broken = document.querySelectorAll('.slot.broken');
            if (broken.length === 5) {
                setTimeout(() => {
                    alert(`GAME OVER\nSCORE: ${score}`);
                    location.reload(); 
                }, 500);
            }
        }

        window.addEventListener('touchstart', () => {
            if (AudioSys.ctx.state === 'suspended') AudioSys.ctx.resume();
        }, { passive: true });

        init();
    </script>
</body>

</html>
